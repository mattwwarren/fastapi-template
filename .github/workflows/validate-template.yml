# validate-template.yml - Validate template generation with different configurations
#
# This workflow ensures that templates generate working projects across
# all supported configuration combinations (auth providers, features).
#
# Runs on:
# - Push to main (when template-related files change)
# - Pull requests to main

name: Validate Template

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'copier.yaml'
      - '_tasks.py'
      - 'scripts/templatize.sh'
      - 'fastapi_template/**'
      - 'pyproject.toml'
      - 'Dockerfile'
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            data_args: ""
          - name: auth-ory
            data_args: "--data auth_enabled=true --data auth_provider=ory"
          - name: auth-auth0
            data_args: "--data auth_enabled=true --data auth_provider=auth0"

    name: Validate (${{ matrix.name }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run templatize script
        run: |
          chmod +x ./scripts/templatize.sh
          ./scripts/templatize.sh .templatized

      - name: Install Copier
        run: pipx install copier

      - name: Generate project (${{ matrix.name }})
        run: |
          copier copy .templatized /tmp/test-project \
            --defaults --trust \
            --data project_name="Test Project" \
            ${{ matrix.data_args }}

      - name: Install dependencies
        run: cd /tmp/test-project && uv sync

      - name: Lint (ruff check)
        run: |
          cd /tmp/test-project
          # Auto-fix import ordering (changes when project_slug differs from fastapi_template)
          uv run ruff check --fix .
          uv run ruff check .

      - name: Type check (mypy)
        run: cd /tmp/test-project && uv run mypy .

      - name: Build Docker image
        run: cd /tmp/test-project && docker build -t test:latest .

      - name: Summary
        if: always()
        run: |
          echo "## Validation: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration: \`${{ matrix.data_args || 'defaults' }}\`" >> $GITHUB_STEP_SUMMARY
